# 栈帧

在 RISC-V 架构中，**栈帧（stack frame）** 是函数调用时用来存储局部变量、返回地址、保存的寄存器等信息的一段栈空间。栈帧的布局虽然不是固定强制的，但有一定的**约定俗成（calling convention）**，特别是在 RISC-V 的标准 ABI（如 RV32I 或 RV64I）中。

------

## 🧩 RISC-V 栈帧结构（通用约定）

一个典型的栈帧结构如下（假设栈向下增长）：

```
+-------------------------------+ <-- 高地址
| 栈上传递的参数 (超过 a7)      | 由调用者填写
+-------------------------------+
| 返回地址 ra（x1）             | 由被调用者保存
| 被调用者保存的 s0-s11 寄存器  | 由被调用者保存
| 本地变量空间                   | 由被调用者使用
| 临时调用其他函数的参数空间    | 被调用者分配，至少 8*8 = 64 字节
+-------------------------------+ <-- sp（对齐到16字节）

```

------

## 📌 栈帧组成详解

| 名称                    | 描述                                                         |
| ----------------------- | ------------------------------------------------------------ |
| **返回地址 `ra`**       | 如果调用另一个函数，需要保存当前函数的返回地址（通常保存在栈中） |
| **保存寄存器 `s0~s11`** | 被调用函数如果使用了这些寄存器，需要保存它们的原值，并在返回前恢复 |
| **临时寄存器 `t0~t6`**  | 不需要保存，它们是 caller-saved，调用者负责保存              |
| **局部变量**            | 一般放在栈上，由函数自行分配空间                             |
| **函数参数**            | 前 8 个参数用 `a0~a7` 传递，更多的参数通过栈传递             |

------

## 📘 示例

一个函数在汇编中分配栈帧的典型方式如下：

```assembly
foo:
    addi sp, sp, -16        # 分配栈空间
    sw   ra, 12(sp)         # 保存返回地址
    sw   s0, 8(sp)          # 保存 s0 寄存器
    addi s0, sp, 16         # 设置帧指针（frame pointer）
    
    ...                     # 函数体
    
    lw   ra, 12(sp)         # 恢复返回地址
    lw   s0, 8(sp)          # 恢复 s0
    addi sp, sp, 16         # 释放栈空间
    ret
```

------

## ✅ 函数调用时的基本规则（RISC-V Calling Convention）

| 类别       | 寄存器    | 说明                            |
| ---------- | --------- | ------------------------------- |
| 返回地址   | `ra`      | 存返回地址                      |
| 栈指针     | `sp`      | 指向当前栈帧底部                |
| 帧指针     | `s0`/`fp` | 有时作为帧指针用                |
| 参数       | `a0-a7`   | 最多 8 个参数通过这些寄存器传递 |
| 返回值     | `a0-a1`   | 返回值存放位置                  |
| 临时寄存器 | `t0-t6`   | 调用者保存（caller-saved）      |
| 保存寄存器 | `s0-s11`  | 被调用者保存（callee-saved）    |

