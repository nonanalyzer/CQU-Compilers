# å®éªŒä¸‰(2025)

æœ¬æ–‡æ¡£ä¸ºå®éªŒæŒ‡å¯¼ä¹¦çš„è¡¥å……è¯´æ˜ï¼Œè¯·åŒå­¦ä»¬ä¼˜å…ˆä»”ç»†é˜…è¯»å®éªŒæŒ‡å¯¼ä¹¦

å®éªŒä¸‰ä¸»è¦å°†çº¿æ€§IRè½¬åŒ–ä¸ºç›®æ ‡ä»£ç ã€‚æœ¬å®éªŒé‡‡ç”¨RiscvæŒ‡ä»¤é›†ï¼Œé€šè¿‡qemuæ¨¡æ‹Ÿè¿è¡Œï¼Œæ¯”å¯¹ç¨‹åºè¿è¡Œç»“æœã€‚

## å‰ç½®çŸ¥è¯†

ä¸ºäº†å®Œæˆå®éªŒä¸‰ä½ å¿…é¡»è¦äº†è§£çš„ä¸€äº›çŸ¥è¯†ã€‚

### æ ˆå¸§(stack frame)

[æ ˆå¸§](æ ˆå¸§.md)

### æ±‡ç¼–ä¼ªæŒ‡ä»¤(pseudo-op / directive)

[æ±‡ç¼–ä¼ªæŒ‡ä»¤](æ±‡ç¼–ä¼ªæŒ‡ä»¤.md)

## æ•°æ®ç»“æ„

```C++
struct Generator
{
    const ir::Program& program;  // the program to gen
    std::ofstream& fout;         // output file
    std::list<std::string> sentences;
    std::list<std::string>::iterator globalSentenece;
    std::list<std::string>::iterator callSentenece;
    std::list<std::string>::iterator funcSentenece;
    stackVarMap* cur_varmap;
    stackVarMap* global_varmap;
    stackVarMap* param_varmap;
    std::vector<std::string>* regTag;
    // std::unordered_map<std::string, rv::rvREG>* regTable;
    std::deque<rv::rvREG> avaliableRegs;
    std::deque<rv::rvFREG> avaliableFRegs;
    Generator(ir::Program&, std::ofstream&);
    //
    VarLocation find_operand(const std::string name);
    void freereg(std::string);
    void freereg(const rv::rvREG);
    void freereg(const rv::rvFREG);
    // reg allocate api
    rv::rvREG getRd(const ir::Operand*);
    rv::rvREG getRs1(const ir::Operand*);
    rv::rvREG getRs2(const ir::Operand*);
    rv::rvFREG fgetRd(const ir::Operand*);
    rv::rvFREG fgetRs1(const ir::Operand*);
    rv::rvFREG fgetRs2(const ir::Operand*);
    rv::rvREG getarr(const ir::Operand*);
    rv::rvREG getnum(const std::string name);
    rv::rvFREG getfnum(const std::string name);
    // generate wrapper function
    void gen();
    void gen_func(const ir::Function&);
    void gen_instr(const ir::Instruction&);
    void gen_globalval(const std::vector<ir::GlobalVal>&);
    void gen_paramval(const std::vector<ir::Operand>&);
};
```

`const ir::Program& program;`æˆ‘ä»¬å®éªŒäºŒç”Ÿæˆçš„ä¸­é—´ä»£ç ç¨‹åº

`std::ofstream& fout;`æˆ‘ä»¬æœ€ç»ˆè¦ç”Ÿæˆçš„æ±‡ç¼–ç¨‹åºæ–‡ä»¶æµ

`std::list<std::string> sentences;
std::list<std::string>::iterator globalSentenece;
std::list<std::string>::iterator callSentenece;
std::list<std::string>::iterator funcSentenece;`

è¿™æ˜¯æˆ‘å½“æ—¶å®šä¹‰çš„å­˜å‚¨æ±‡ç¼–ç¨‹åºçš„ç»“æ„ï¼Œé‡‡ç”¨é“¾è¡¨æ–¹ä¾¿å¢åˆ æ±‡ç¼–æŒ‡ä»¤ã€‚ä»¥åŠå®šä¹‰äº†å‡ ä¸ªâ€œé”šç‚¹â€æ–¹ä¾¿æˆ‘ä»¬åœ¨ç‰¹å®šä½ç½®å¢åŠ åˆ é™¤æ±‡ç¼–æŒ‡ä»¤ã€‚

` stackVarMap* cur_varmap;
stackVarMap* global_varmap;
stackVarMap* param_varmap;`

ä¸‰çº§ç¬¦å·è¡¨ï¼Œæ–¹ä¾¿æˆ‘ä»¬æŸ¥è¯¢éå†å­˜å‚¨çš„å†…å­˜åœ°å€ï¼ŒæŸ¥è¯¢çš„é¡ºåºä¸º`cur_varmap`$\rightarrow$`param_varmap`$\rightarrow$`global_varmap`

`std::vector<std::string>* regTag;`æ¯ä¸ªå¯„å­˜å™¨ä¸­å­˜å‚¨çš„å˜é‡å

`std::unordered_map<std::string, rv::rvREG>* regTable;`ä¸Šä¸€ä¸ªçš„åæŸ¥è¡¨ï¼Œé€šè¿‡å˜é‡åæŸ¥æ‰¾å¯„å­˜å™¨å

`std::deque<rv::rvREG> avaliableRegs;
std::deque<rv::rvFREG> avaliableFRegs;`

æ™®é€šå¯„å­˜å™¨å’Œæµ®ç‚¹å¯„å­˜å™¨ä¸­ç©ºé—²çš„å¯„å­˜å™¨åˆ—è¡¨ã€‚

`Generator(ir::Program&, std::ofstream&);`æ„é€ å‡½æ•°

`VarLocation find_operand(const std::string name);`æŸ¥æ‰¾å˜é‡å¯¹åº”çš„å†…å­˜ç©ºé—´

`void freereg(std::string);
void freereg(const rv::rvREG);
void freereg(const rv::rvFREG);`

é€šè¿‡å˜é‡å/å¯„å­˜å™¨åé‡Šæ”¾å¯„å­˜å™¨

`rv::rvREG getRd(const ir::Operand*);
rv::rvREG getRs1(const ir::Operand*);
rv::rvREG getRs2(const ir::Operand*);
rv::rvFREG fgetRd(const ir::Operand*);
rv::rvFREG fgetRs1(const ir::Operand*);
rv::rvFREG fgetRs2(const ir::Operand*);
rv::rvREG getarr(const ir::Operand*);
rv::rvREG getnum(const std::string name);
rv::rvFREG getfnum(const std::string name);`

ä¸ºæ¯ä¸€ä¸ªå˜é‡åˆ†é…å¯„å­˜å™¨

`void gen();
void gen_func(const ir::Function&);
void gen_instr(const ir::Instruction&);
void gen_globalval(const std::vector<ir::GlobalVal>&);
void gen_paramval(const std::vector<ir::Operand>&);`

ç”Ÿæˆå‡½æ•°ã€ä¸€æ¡æŒ‡ä»¤ã€å…¨å±€å˜é‡ã€å‚æ•°è°ƒç”¨çš„æ±‡ç¼–ï¼Œè°ƒç”¨é¡ºåºä¸º`gen()`$\rarr$`gen_globalval,genfunc()`	`genfunc()`$\rarr$`geninstr(),gen_paramval()` 

## ç®—æ³•

### ç”Ÿæˆæ•´ä¸ªç¨‹åº

```
Function gen()
Begin
	è°ƒç”¨gen_globalval();
	è°ƒç”¨gen_func();
End
```

### ç”Ÿæˆå…¨å±€å˜é‡

#### ç”Ÿæˆå…¨å±€å˜é‡v

```
.data
.globl v
v:
	.word vçš„å€¼(å¦‚Zero,42,0x2a,4.2 .etc)
```

#### ç”Ÿæˆå…¨å±€æ•°ç»„array

åªåˆ†é…ç©ºé—´ä¸åˆå§‹åŒ–

```
.data
.globl array
array:
	.space æ•°ç»„çš„å¤§å°*4
```

â—æ³¨æ„ï¼Œ.spaceä»¥å­—èŠ‚ä¸ºå¤§å°åˆ†é…ï¼Œè€Œæˆ‘ä»¬çš„æ•°ç»„å¤§å°å•ä½æ˜¯å­—ï¼Œæ‰€ä»¥å­—èŠ‚=å­—*4

åˆå§‹åŒ–

```
.data
.globl array
array:
    .word 1, 2, 3, 4, 5  # æ¯ä¸ª .word æ˜¯ 4 å­—èŠ‚
```

åˆå§‹åŒ–å…¨0

```
.data
.globl array
array:
    .zero æ•°ç»„çš„å¤§å°*4          # åˆ†é… 32 å­—èŠ‚å¹¶å…¨éƒ¨ç½®ä¸º 0
```

### ç”Ÿæˆå‡½æ•°

```
Function gen()
Begin
	è®¾ç½®æ–°çš„cur_varmapã€param_varmapã€regTagã€regTableç­‰
	ç”Ÿæˆå‡½æ•°çš„å‰åŠéƒ¨åˆ†
	è°ƒç”¨gen_paramval(å‡½æ•°å‚æ•°åˆ—è¡¨);
	å¯¹äºå‡½æ•°ä¸­æ¯æ¡æŒ‡ä»¤instï¼Œè°ƒç”¨gen_instr(inst);
	ç”Ÿæˆå‡½æ•°çš„ååŠéƒ¨åˆ†
	åˆ é™¤cur_varmapã€param_varmapã€regTagã€regTableç­‰
End
```

#### å‡½æ•°çš„å‰åŠéƒ¨åˆ†

##### å‡½æ•°å®šä¹‰func

```assembly
.align 	1
.globl	func
.type	func,	@function
func:
```

##### æ ˆæŒ‡é’ˆç§»åŠ¨

```assembly
addi	sp,sp,-æ ˆå¸§å¤§å°
```

##### è¢«è°ƒç”¨è€…ä¿å­˜å¯„å­˜å™¨ï¼š

åœ¨ RISC-V æ¶æ„ä¸­ï¼Œ**è¢«è°ƒç”¨è€…ä¿å­˜å¯„å­˜å™¨ï¼ˆcallee-saved registersï¼‰** æ˜¯æŒ‡ï¼šå½“ä¸€ä¸ªå‡½æ•°ä½¿ç”¨è¿™äº›å¯„å­˜å™¨æ—¶ï¼Œå®ƒ**å¿…é¡»è‡ªå·±ä¿å­˜å¹¶åœ¨è¿”å›å‰æ¢å¤åŸå€¼**ï¼Œä»¥é˜²æ­¢ç ´åè°ƒç”¨è€…çš„çŠ¶æ€ã€‚

è¿™æ ·çš„å¯„å­˜å™¨æœ‰ï¼š

1. s0 (x8 æ ˆæŒ‡é’ˆ frame pointer)

2. s1 (x9,é€šç”¨å¯„å­˜å™¨)

3. s2~s11 (x18-x27,é€šç”¨å¯„å­˜å™¨)

4. ra ï¼ˆx1è¿”å›åœ°å€ï¼‰

ä¸€èˆ¬æ¥è¯´ï¼Œè¿™äº›å¯„å­˜å™¨ä¿å­˜åœ¨æ ˆå¸§çš„é«˜åœ°å€ç©ºé—´ï¼Œå‡è®¾æ ˆå¸§å¤§å°ä¸ºframe_size(512)ï¼Œå¹¶ä¸”å‡½æ•°ä¼ å‚ä¸è¶…è¿‡8ä¸ªï¼ˆè¯¦è§[ç”Ÿæˆå‡½æ•°è°ƒç”¨åˆ—è¡¨](#ç”Ÿæˆå‡½æ•°è°ƒç”¨åˆ—è¡¨)ï¼‰

```assembly
sw	ra, frame_size - 4(sp) #sw	ra, 508(sp)
sw	s0, frame_size - 8(sp) #sw	s0, 504(sp)
sw	s1, frame_size - 12(sp) #sw	s1, 500(sp)
sw	s2, frame_size - 16(sp) #sw	s2, 496(sp)
sw	s3, frame_size - 20(sp) #sw	s3, 492(sp)
sw	s4, frame_size - 24(sp) #sw	s4, 488(sp)
sw	s5, frame_size - 28(sp) #sw	s5, 484(sp)
sw	s6, frame_size - 32(sp) #sw	s6, 480(sp)
sw	s7, frame_size - 36(sp) #sw	s7, 476(sp)
sw	s8, frame_size - 40(sp) #sw	s8, 472(sp)
sw	s9, frame_size - 44(sp) #sw	s9, 468(sp)
sw	s10, frame_size - 48(sp) #sw	s10, 464(sp)
sw	s11, frame_size - 52(sp) #sw	s11, 460(sp)
sw	s12, frame_size - 56(sp) #sw	s12, 456(sp)
```

##### æ ˆé¡¶æŒ‡é’ˆç§»åŠ¨

```assembly
addi	s0,sp,æ ˆå¸§å¤§å°
```

è¿™æ ·sp(ä½åœ°å€)-s0(é«˜åœ°å€)è¿™ä¸€æ®µæ ˆå¸§å°±æ˜¯å‡½æ•°ç”¨åˆ°çš„æ‰€æœ‰å†…å­˜ç©ºé—´ã€‚

#### å‡½æ•°çš„ååŠéƒ¨åˆ†

##### æ¢å¤è¢«è°ƒç”¨è€…ä¿å­˜å¯„å­˜å™¨ï¼š

```assembly
lw	ra, frame_size - 4(sp) #sw	ra, 508(sp)
lw	s0, frame_size - 8(sp) #sw	ra, 504(sp)
lw	s1, frame_size - 12(sp) #sw	ra, 500(sp)
lw	s2, frame_size - 16(sp) #sw	ra, 496(sp)
lw	s3, frame_size - 20(sp) #sw	ra, 492(sp)
lw	s4, frame_size - 24(sp) #sw	ra, 488(sp)
lw	s5, frame_size - 28(sp) #sw	ra, 484(sp)
lw	s6, frame_size - 32(sp) #sw	ra, 480(sp)
lw	s7, frame_size - 36(sp) #sw	ra, 476(sp)
lw	s8, frame_size - 40(sp) #sw	ra, 472(sp)
lw	s9, frame_size - 44(sp) #sw	ra, 468(sp)
lw	s10, frame_size - 48(sp) #sw	ra, 464(sp)
lw	s11, frame_size - 52(sp) #sw	ra, 460(sp)
lw	s12, frame_size - 56(sp) #sw	ra, 456(sp)
```

##### æ¢å¤æ ˆæŒ‡é’ˆï¼š

```
addi	sp,sp,æ ˆå¸§å¤§å°
```

##### è·³è½¬å›ra

```
jr ra
```

##### å…¶ä»–å®šä¹‰

```
.size	func, . -func
```

ç”¨æ¥å‘Šè¯‰æ±‡ç¼–å™¨/é“¾æ¥å™¨è¿™ä¸ªå‡½æ•° `func` çš„ **å¤§å°ï¼ˆä»¥å­—èŠ‚ä¸ºå•ä½ï¼‰**ã€‚

### ç”Ÿæˆå‡½æ•°è°ƒç”¨åˆ—è¡¨

æ ¹æ®riscv64çš„abiå®šä¹‰ï¼Œå‡½æ•°çš„å‰8ä¸ªå‚æ•°é€šè¿‡å¯„å­˜å™¨a0~a7ä¼ é€’ï¼Œå‰©ä½™çš„é€šè¿‡æ ˆä¼ é€’ã€‚

>The base integer calling convention provides eight argument registers, a0-a7, the first two of which are also used to return values.
>
>åŸºç¡€æ•´æ•°è°ƒç”¨çº¦å®šæä¾›äº†å…«ä¸ªå‚æ•°å¯„å­˜å™¨ï¼Œa0 åˆ° a7ï¼Œå…¶ä¸­å‰ä¸¤ä¸ªï¼ˆa0 å’Œ a1ï¼‰ä¹Ÿç”¨äºè¿”å›å‡½æ•°çš„è¿”å›å€¼ã€‚
>
>...
>
>The stack grows downwards (towards lower addresses) and the stack pointer shall be aligned to a 128-bit boundary upon procedure entry. The first argument passed on the stack is located at offset zero of the stack pointer on function entry; following arguments are stored at correspondingly higher addresses.
>
>æ ˆå‘ä¸‹å¢é•¿ï¼ˆå³æœç€æ›´ä½çš„åœ°å€æ–¹å‘ï¼‰ï¼Œå¹¶ä¸”åœ¨å‡½æ•°å…¥å£å¤„ï¼Œæ ˆæŒ‡é’ˆï¼ˆ`sp`ï¼‰å¿…é¡»å¯¹é½åˆ°**128 ä½(16 å­—èŠ‚)**è¾¹ç•Œã€‚**é€šè¿‡æ ˆä¼ é€’çš„ç¬¬ä¸€ä¸ªå‚æ•°ä½äºå‡½æ•°å…¥å£æ—¶æ ˆæŒ‡é’ˆçš„åç§»é‡ä¸º 0 çš„ä½ç½®ï¼›åç»­å‚æ•°ä¾æ¬¡å­˜æ”¾åœ¨æ›´é«˜çš„åœ°å€ä¸Š**ã€‚
>
><p style="text-align:right"><a href="https://d3s.mff.cuni.cz/files/teaching/nswi200/202324/doc/riscv-abi.pdf" >â€”â€”[RISC-V ABIs Specification] 2.1. Integer Calling Convention</a></p>



å‡è®¾æŸä¸ªå‡½æ•°æœ‰11ä¸ªå‚æ•°ï¼Œé‚£ä¹ˆæœ‰æ ˆå¸§é«˜åœ°å€å¾€ä¸‹æœ‰3\*4=12å­—èŠ‚çš„ç©ºé—´å­˜æ”¾å‡½æ•°å‚æ•°ã€‚å†14\*4=56å­—èŠ‚ç©ºé—´å­˜æ”¾è¢«è°ƒç”¨è€…ä¿å­˜å¯„å­˜å™¨

å±€éƒ¨å˜é‡ç©ºé—´ä»æ ˆå¸§çš„ç¬¬68å­—èŠ‚å¾€ä½å­—èŠ‚å¼€å§‹å³-68(s0)å¼€å§‹

é‚£ä¹ˆå¯¹äºå‰8ä¸ªå‚æ•°æœ‰

```assembly
mv t0,a0
sw t0,-68(s0)
mv t0,a1
sw t0,-72(s0)
mv t0,a2
sw t0,-76(s0)
mv t0,a3
sw t0,-80(s0)
mv t0,a4
sw t0,-84(s0)
mv t0,a5
sw t0,-88(s0)
mv t0,a6
sw t0,-92(s0)
mv t0,a7
sw t0,-96(s0)
```

é‚£ä¹ˆå¯¹äºç¬¬9ï¼Œ10ï¼Œ11ä¸ªå‚æ•°æœ‰

```
lw t0,-8(s0)
sw t0,-100(s0)
lw t0,-4(s0)
sw t0,-104(s0)
lw t0,-0(s0)
sw t0,-108(s0)
```

```
Function gen_paramval()
Begin
	for å¯¹äºæ¯ä¸ªå‚æ•°v
	Begin
		if vä¸ºå‰8ä¸ªå‚æ•° then
			ç”Ÿæˆç‰¹å®šçš„æ±‡ç¼–(mv,sw)
		else then
			ç”Ÿæˆç‰¹å®šçš„æ±‡ç¼–(lw,sw)
		endif
		å°†våœ¨å±€éƒ¨å˜é‡ä¸­çš„åœ°å€å­˜è´®åˆ°cur_varmapä¸­
	End for
End
```

### ç”ŸæˆæŸæ¡æŒ‡ä»¤

```c++
enum class Operator {
    _return,    // return   op1
    _goto,      // goto     [op1=cond_var/null],    des = offset
    call,       // call     op1 = func_name,    des = retval  /* func.name = function, func.type = return type*/
    // alloc [arr_size]*4 byte space on stack for array named [arr_name], do not use this for global arrays
    alloc,      // alloc    op1 = arr_size,     des = arr_name
    store,      // store    des,    op1,    op2    op2ä¸ºä¸‹æ ‡ -> åç§»é‡  op1ä¸º store çš„æ•°ç»„å, des ä¸ºè¢«å­˜å‚¨çš„å˜é‡
    load,       // load     des,    op1,    op2    op2ä¸ºä¸‹æ ‡ -> åç§»é‡  op1ä¸º load çš„æ•°ç»„å, des ä¸ºè¢«èµ‹å€¼å˜é‡
    getptr,     // op1: arr_name, op2: arr_off

    def,
    fdef,
    mov,
    fmov,
    cvt_i2f,    // convert [Int]op1 to [Float]des 
    cvt_f2i,    // convert [Float]op1 to [Int]des
    add,
    addi,
    fadd,
    sub,
    subi,
    fsub,
    mul,
    fmul,
    div,
    fdiv,
    mod,
    lss,
    flss,
    leq,
    fleq,
    gtr,
    fgtr,
    geq,
    fgeq,
    eq,
    feq,
    neq,
    fneq,
    _not,
    _and,
    _or,
    __unuse__
};
```

#### ä¸€èˆ¬æ•´å‹æŒ‡ä»¤

å¦‚`add,sub,mul,div,def,gtr,eq`ç­‰ï¼Œå‡è®¾åˆ†æçš„æ˜¯op des,src0,sr1è¿™æ¡æŒ‡ä»¤ï¼Œæœ‰å¦‚ä¸‹çš„ä¼ªä»£ç 

```
Function gen_inst()
Begin
	ç”³è¯·desçš„å¯„å­˜å™¨reg0
	è·å–src0çš„å¯„å­˜å™¨reg1
	è·å–src1çš„å¯„å­˜å™¨reg2
	ç”ŸæˆriscvæŒ‡ä»¤[riscv-op reg0,reg1,reg2] #add t0,t1,t2
End
```

#### ç«‹å³æ•°æŒ‡ä»¤

å¦‚`addi,subi`ç­‰ï¼Œå‡è®¾åˆ†æçš„æ˜¯op des,src0,sr1è¿™æ¡æŒ‡ä»¤ï¼Œæœ‰å¦‚ä¸‹çš„ä¼ªä»£ç 

```
Function gen_inst()
Begin
	ç”³è¯·desçš„å¯„å­˜å™¨reg0
	è·å–src0çš„å¯„å­˜å™¨reg1
	è·å–src1çš„æ•°å€¼num
	ç”ŸæˆriscvæŒ‡ä»¤[riscv-op reg0,reg1,num] #addi t0,t1,3
End
```

#### ä¸€èˆ¬æµ®ç‚¹æ•°æŒ‡ä»¤

å¦‚`fadd,fmul,fdiv,fdef`ç­‰ï¼Œå‡è®¾åˆ†æçš„æ˜¯op des,src0,sr1è¿™æ¡æŒ‡ä»¤ï¼Œæœ‰å¦‚ä¸‹çš„ä¼ªä»£ç 

```
Function gen_inst()
Begin
	ç”³è¯·desçš„æµ®ç‚¹å¯„å­˜å™¨freg0
	è·å–src0çš„æµ®ç‚¹å¯„å­˜å™¨freg1
	è·å–src1çš„æµ®ç‚¹å¯„å­˜å™¨freg2
	ç”ŸæˆriscvæŒ‡ä»¤[riscv-op reg0,reg1,reg2] #fadd ft0,ft1,ft2
End
```

#### è·³è½¬æŒ‡ä»¤

å¯¹äº`_goto`æŒ‡ä»¤æœ‰

```
Function gen_inst()
Begin
	if _gotoæŒ‡ä»¤çš„ç¬¬ä¸€ä¸ªæ“ä½œæ•°æœ‰å€¼ then
		è·å–ç¬¬ä¸€ä¸ªæ“ä½œæ•°çš„å¯„å­˜å™¨reg0
		è·å–è¦è·³è½¬åˆ°çš„æ ‡ç­¾label
		ç”ŸæˆriscvæŒ‡ä»¤[BNE reg0,Zero,label] #bne t0,zero,label
	else then
		è·å–è¦è·³è½¬åˆ°çš„æ ‡ç­¾label
		ç”ŸæˆriscvæŒ‡ä»¤[J label] #j label
End
```

ğŸ§ å¦‚æœ_gotoæŒ‡ä»¤çš„ç¬¬ä¸€ä¸ªæ“ä½œæ•°æ˜¯æµ®ç‚¹æ•°ï¼Œåº”è¯¥æ€ä¹ˆåŠï¼Ÿ

#### allocæŒ‡ä»¤

å…³äº[VLA(Variable Length Array)](vla.md)

ç°åœ¨çš„ä¸»æµçœ‹æ³•æ˜¯ç¦ç”¨VLAï¼Œåœ¨æˆ‘ä»¬çš„å®éªŒä¸­æœ‰ä¸”ä»…æœ‰ä¸€æ¡è·ŸVLAæœ‰å…³çš„æµ‹è¯•ç”¨ä¾‹

34_arr_expr_len.sy

```
const int N = -1;
int arr[N + 2 * 4 - 99 / 99] = {1, 2, 33, 4, 5, 6};
```

æˆ‘ä»¬å¯ä»¥é€šè¿‡å¸¸é‡ä¼ æ’­è®¡ç®—æ¥ç»•è¿‡å®ƒï¼Œå°†å…¶å˜æˆ

```
const int N = -1;
int arr[6] = {1, 2, 33, 4, 5, 6};
```

æ‰€ä»¥æ¥ä¸‹æ¥åªè®¨è®º`alloc array,6`è¿™æ ·çš„å½¢å¼

```
Function gen_inst()
Begin
	è·å–è¦åˆ†é…çš„æ•°ç»„åç§°array
	è·å–æ•°ç»„å¤§å°num
	è·å–ä¸‹ä¸€ä¸ªå¯ç”¨çš„å±€éƒ¨ç©ºé—´åœ°å€åç§»é‡offset
	å°†æŒ‡é’ˆçš„å±€éƒ¨ç©ºé—´åœ°å€offsetä¿å­˜åˆ°cur_varmapä¸­
	è®¾ç½®ä¸‹ä¸€ä¸ªå¯ç”¨çš„å±€éƒ¨ç©ºé—´åœ°å€åç§»é‡ä¸ºoffset+4*num
	endif
End
```

#### loadæŒ‡ä»¤

```
Function gen_inst()
Begin
	ç”³è¯·desç›®æ ‡æ“ä½œæ•°çš„å¯„å­˜å™¨reg0
	è·å–arrayæŒ‡é’ˆçš„å¯„å­˜å™¨reg1
	if ç¬¬äºŒä¸ªæ“ä½œæ•°æ˜¯å€¼ then
		è·å–ç¬¬äºŒä¸ªæ“ä½œæ•°çš„å€¼num
		ç”ŸæˆriscvæŒ‡ä»¤[lw reg0,4*num(reg1)]	#lw t0,-4(t1)
	else then
		è·å–ç¬¬äºŒä¸ªæ“ä½œæ•°çš„å¯„å­˜å™¨reg2
		ç”ŸæˆriscvæŒ‡ä»¤[slli reg2,reg2,2]		#slli t2,t2,2 ç›¸å½“äºä¹˜4
		ç”ŸæˆriscvæŒ‡ä»¤[sub reg1,reg1,reg2]	#sub t2,t1,t2 æ‰¾åˆ°æ•°æ®çš„å­˜æ”¾åœ°å€ï¼Œt1æ˜¯æ•°ç»„å¼€å¤´ä½ç½®ï¼Œåœ¨é«˜åœ°å€ï¼Œæ‰€ä»¥è¦åšå‡æ³•
		ç”ŸæˆriscvæŒ‡ä»¤[lw reg0,0(reg1)]		#lw t0,0(t2)
	endif
End
```

ğŸ§ å¦‚æœä¿å­˜çš„æ˜¯æµ®ç‚¹æ•°ï¼Œåº”è¯¥æ€ä¹ˆåšï¼Ÿ

#### _returnæŒ‡ä»¤

returnæŒ‡ä»¤éœ€è¦å°†è¿”å›å€¼å¯„å­˜å™¨a0è®¾ä¸ºè¦è¿”å›çš„å€¼ï¼Œç„¶åå¼€å§‹æ‰§è¡Œ[å‡½æ•°çš„ååŠéƒ¨åˆ†](#å‡½æ•°çš„ååŠéƒ¨åˆ†)

#### callæŒ‡ä»¤

æ ¹æ®[ç”Ÿæˆå‡½æ•°è°ƒç”¨åˆ—è¡¨](#ç”Ÿæˆå‡½æ•°è°ƒç”¨åˆ—è¡¨)ï¼Œæˆ‘ä»¬éœ€è¦å…ˆå°†a0~a7è®¾ç½®ä¸ºå‰8ä¸ªè°ƒç”¨å‚æ•°ï¼Œå†å°†-0(sp) -4(sp)ç­‰ä½ç½®è®¾ç½®ä¸ºåé¢çš„å‡½æ•°è°ƒç”¨å‚æ•°ï¼Œå†è°ƒç”¨`call func`å¼€å§‹æ‰§è¡Œï¼Œæœ€å`sw a0,è¦ä¿å­˜çš„å±€éƒ¨å˜é‡åœ¨å†…å­˜ä¸­çš„ä½ç½®`å³å¯ã€‚

### å¯„å­˜å™¨åˆ†é…è§„åˆ™

è¯¦è§å®éªŒæŒ‡å¯¼ä¹¦â€œå¯„å­˜å™¨åˆ†é…â€ä¸€èŠ‚

## ~~å¦‚ä½•å·æ‡’~~

1. å¯„å­˜å™¨åˆ†é…å¤ªéš¾äº†ï¼Œå¯¹äºåˆ†æ”¯è¯­å¥æˆ–å¾ªç¯è¯­å¥é‡‡ç”¨å†™å›ç­–ç•¥ç®€ç›´å°±æ˜¯ç¾éš¾(æœ‰å…´è¶£çš„å°ä¼™ä¼´å¯ä»¥å°è¯•å®ç°å†™å›ç­–ç•¥ï¼Œæ³¨æ„è¦æ ‡æ³¨å¾ªç¯èµ·å§‹ä½ç½®ä»¥åŠå¾ªç¯çš„_goto irè¯­å¥)ã€‚æœ€ç®€å•çš„ç­–ç•¥å°±æ˜¯æœ€å¥½çš„ç­–ç•¥ï¼Œæˆ‘ä»¬æ¯èµ‹å€¼ä¸€ä¸ªå˜é‡ï¼Œéƒ½è®©å®ƒåœ¨åœ¨å†…å­˜ä¸­ä¿å­˜ä¸€ä¸‹ï¼

```
lw 		s0,offset0(s0) 	#è¯»å–æ“ä½œæ•°1
lw 		s1,offset1(s0) 	#è¯»å–æ“ä½œæ•°2
?add?	s2,s0,s1		#è®¡ç®—ç›®æ ‡æ“ä½œæ•°
sw		s2,offset2(s0)	#ä¿å­˜ç›®æ ‡æ“ä½œæ•°
```

æˆ‘ä»¬çš„ç­–ç•¥å°±æ˜¯åªç”¨s0,s1,s2ä¸‰ä¸ªå¯„å­˜å™¨ï¼(æˆ‘å½“æ—¶å°±è¿™ä¹ˆå¹²çš„)

ç„¶åå‡½æ•°çš„å¼€å¤´å’Œç»“å°¾ä¹Ÿä¸éœ€è¦ä¿å­˜å’Œæ¢å¤s3~s12ï¼Œå› ä¸ºæ ¹æœ¬æ²¡ç”¨åˆ°ï¼ğŸ˜€

2. å¦‚ä½•ç¡®å®šæ ˆå¸§çš„åˆ†é…å¤§å°å¤ªéš¾äº†ï¼Œæˆ‘åˆå¾—è€ƒè™‘VLAï¼Œåˆå¾—è€ƒè™‘è¦è¢«è°ƒç”¨è€…ä¿å­˜å¯„å­˜å™¨ï¼Œè¿˜è¦è€ƒè™‘å±€éƒ¨å˜é‡çš„æ•°é‡ï¼å¤ªçƒ¦äº†ï¼Œæˆ‘å†³å®šç›´æ¥è®¾ç½®frame_sizeä¸º512ï¼åˆšå¥½èƒ½è¿‡æ‰€æœ‰æµ‹è¯•ç‚¹ï¼ğŸ˜€

3. å¦‚ä½•ç»Ÿè®¡å“ªäº›è¢«è°ƒç”¨è€…ä¿å­˜å¯„å­˜å™¨è¢«ä½¿ç”¨å¤ªéš¾äº†ï¼Œæˆ‘å†³å®šå°†æ‰€æœ‰è¢«è°ƒç”¨è€…ä¿å­˜å¯„å­˜å™¨ï¼ˆra,s0~s12ï¼‰éƒ½ä¿å­˜ä¸€éï¼ä¸ç®¡å®ƒæœ‰æ²¡æœ‰è¢«ç”¨åˆ°ï¼ğŸ˜€

4. è¿™ä¸ªæ•°ç»„è¿˜è¦å®ç°VLAï¼Œå¤ªå¤æ‚äº†ï¼Œåˆšå¥½æµ‹è¯•æ ·ä¾‹ä¸­æ²¡æœ‰ç›¸å…³çš„æ ·ä¾‹ï¼Œåªè¦æŠŠ34_arr_expr_len.syè¿‡äº†å°±è¡Œï¼Œæˆ‘å†³å®šä½¿ç”¨ä¸€ç§å¸¸é‡ä¼ æ’­ä¼˜åŒ–ï¼Œå°†å…¶ä¼˜åŒ–æ‰ï¼Œè¿™æ ·å°±ä¸éœ€è¦å®ç°VLAå•¦ï¼ğŸ˜€

5. è¿™ä¸ªæ•°ç»„è¿˜è¦å®ç°VLAï¼Œå¤ªå¤æ‚äº†ï¼Œæˆ‘å†³å®šç›´æ¥å°†å±€éƒ¨æ•°ç»„ç»Ÿç»Ÿå˜æˆå…¨å±€æ•°ç»„ï¼Œç„¶åå¼€è¾Ÿä¸€ä¸ª1024å­—èŠ‚çš„ç©ºé—´ï¼Œåˆšå¥½èƒ½è¦†ç›–æ‰æ‰€æœ‰æµ‹è¯•æ ·ä¾‹ï¼Œè¿™æ ·å°±ä¸ç”¨è€ƒè™‘VLAå•¦ï¼ğŸ˜€

â—åé¢æ•™æè¯·å‹¿å­¦ä¹ ~~ï¼ˆé™¤éå¿«åˆ°DDLäº†ï¼‰~~
